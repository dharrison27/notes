[1.1]: #upgrade-and-migration "Install, upgrade and migrate servers and workloads"
[1.2]: #nano-server "Install and configure Nano Server"
[1.3]: #images "Create, manage, and maintain images for deployment"
[2.1]: #disks-and-volumes "Configure disks and volumes"
[2.2]: #server-storage "Implement server storage"
[2.3]: #data-deduplication "Implement data deduplication"
[3.1]: #hyper-v-configuration "Install and configure Hyper-V"
[3.2]: #vm-configuration "Configure virtual machine (VM) settings"
[3.3]: #hyper-v-storage "Configure Hyper-V storage"
[3.4]: #hyper-v-networking "Configure Hyper-V networking"
[4.1]: #container-deployment "Deploy Windows containers"
[4.2]: #container-management "Manage Windows containers"
[5.1]: #high-availability "Implement high availability and disaster recovery options in Hyper-V"
[5.2]: #failover-clustering "Implement failover clustering"
[5.3]: #storage-spaces-direct "Implement Storage Spaces Direct"
[5.4]: #cluster-management "Manage failover clustering"
[5.5]: #moving-cluster-vms "Manage VM movement in clustered nodes"
[5.6]: #nlb "Implement Network Load Balancing"
[6.1]: #maintenance "Maintain server installations"
[6.2]: #monitoring "Monitor server installations"

[Zacker]: https://github.com/jasper-zanjani/notes/master/certs/70-740.md "Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017."
[n/pwsh]: https://github.com/jasper-zanjani/notes/master/win/pwsh.md "Powershell notes"
[pl:70-740]: # 'MeasureUp Practice Lab: Installation, Storage and Compute with Windows Server 2016 (70-740)'
[mu:70-740]: # 'MeasureUp Practice Test. _Installation, Storage and Compute with Windows Server 2016 (70-740)_.'

<!--- CMD commands -->
[Azman.msc]: README.md#azman.msc '```&#10;C:\>Azman.msc&#10;```&#10;Authorization Manager, tool for granting specific privileges to users; deprecated in Windows Server 2012 R2&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 174'
[cmdkey.exe]: README.md#cmdkey.exe '```&#10;C:\>cmdkey.exe&#10;```&#10;Creates, lists, and deletes stored user names and passwords or credentials'
[Configure-SMRemoting.exe]: README.md#configure-smremoting.exe '```&#10;C:\>Configure-SMRemoting.exe&#10;```&#10;Enable remote management using Server Manager'
[ddpeval.exe]: README.md#ddpeval.exe '```&#10;C:\>ddpeval.exe&#10;```&#10;Data Deduplication Savings Evaluation Tool that can be used to test a volume to see how much storage savings can result from optimization'
[dism.exe]: README.md#dism.exe '```&#10;C:\>dism.exe&#10;```&#10;"Deployment Image Servicing and Management", enables modification of VHD and Windows Imaging files while they are offline&#10;Sobell, Mark. _Practical Guide to Linux_. 2017.: 70'
[VMConnect.exe]: README.md#vmconnect.exe '```&#10;C:\>VMConnect.exe&#10;```&#10;"Virtual Machine Connection", Hyper-V tool used to connect to a running VM and access its desktop'

# Installation, Storage and Compute with Windows Server 2016 (70-740)

- [Installation, Storage and Compute with Windows Server 2016 (70-740)](#installation-storage-and-compute-with-windows-server-2016-70-740)
    - [Installation](#installation)
      - [Upgrade and migration](#upgrade-and-migration)
      - [Nano Server](#nano-server)
      - [Images](#images)
    - [Storage](#storage)
      - [Disks and volumes](#disks-and-volumes)
          - [Partition vs. volume](#partition-vs-volume)
      - [Server storage](#server-storage)
      - [Data deduplication](#data-deduplication)
    - [Hyper-V](#hyper-v)
      - [Hyper-V configuration](#hyper-v-configuration)
      - [VM configuration](#vm-configuration)
      - [Hyper-V storage](#hyper-v-storage)
      - [Hyper-V networking](#hyper-v-networking)
    - [Windows containers](#windows-containers)
      - [Container deployment](#container-deployment)
      - [Container management](#container-management)
    - [Clusters](#clusters)
      - [High availability](#high-availability)
      - [Failover clustering](#failover-clustering)
      - [Storage Spaces Direct](#storage-spaces-direct)
      - [Moving cluster VMs](#moving-cluster-vms)
      - [NLB](#nlb)
    - [Maintenance and monitoring](#maintenance-and-monitoring)
      - [Maintenance](#maintenance)
      - [Monitoring](#monitoring)
- [Labs](#labs)
    - [Server Core](#server-core)
    - [Nano Server](#nano-server-1)
    - [Windows Deployment Services](#windows-deployment-services)
    - [DISM](#dism)
    - [NLB lab](#nlb-lab)
    - [iSCSI Storage](#iscsi-storage)
    - [Failover cluster lab](#failover-cluster-lab)
          - [Configure iSCSI initiators to iSCSI Target Server](#configure-iscsi-initiators-to-iscsi-target-server)
          - [Install failover clusters](#install-failover-clusters)
    - [Scale-Out Fileserver lab](#scale-out-fileserver-lab)
    - [Hyper-V storage lab](#hyper-v-storage-lab)
    - [Hyper-V replica lab](#hyper-v-replica-lab)
    - [WSUS lab](#wsus-lab)
    - [Storage replica lab](#storage-replica-lab)

[servicing channel]: # 'servicing channel&#10;provide a way of separating users into deployment groups for feature and quality updates'
[Semi-Annual Channel]: # 'Semi-Annual Channel&#10;previously "Current Branch for Business (CBB)", servicing channel that receives feature updates twice a year'
[LTSC]: # 'Long Term Servicing Channel (LTSC)&#10;servicing branch with a minimum servicing lifetime of 10 years, designed to be used only for specialized devices such as those that control medical equipment or ATM machines, receiving new feature releases every 2-3 years'

- [Servicing channels][servicing channel]
  - [Semi-Annual Channel][Semi-Annual Channel]
  - [Long Term Servicing Channel][LTSC]
### Installation
#### Upgrade and migration
[Activation threshold]: #upgrade-and-migration 'Activation threshold&#10;Minimum of 25 workstation systems or five server systems as clients for KMS&#10;KMS hosts maintain a cache of the 50 most recent workstation requests, and KMS activations expire every 180 days (ref Activation validity interval). &#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 36'
[Activation validity interval]: #upgrade-and-migration 'Activation validity interval&#10;180 days for KMS activations, although clients attempt to renew every 7 days&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 37'
[Active Directory-based activation]: #upgrade-and-migration 'Active Directory-based activation&#10;Use of AD DS for communication and data storage instead of a KMS host&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 39'
[AVMA]: #upgrade-and-migration 'Automatic Virtual Machine Activation (AVMA)&#10;Simplifies the process of activating VMs created on Hyper-V servers, whereby a binding is created between the host server and the activation mechanism on each VM, which are activated automatically and remain so.&#10;Requires Datacenter Edition of WS 2016 or WS 2012 R2 on the host server and a specific key, depending on the version of Windows Server on the VM.&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 41'
[clean installation]: #upgrade-and-migration 'clean installation&#10;also "bare-metal installation", installing an OS on a computer that does not already have one&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 6'
[DCOM]: #upgrade-and-migration 'Distributed Component Object Model (DCOM)&#10;used by MMC for remote management&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 25'
[DSC]: #upgrade-and-migration 'Desired State Configuration (DSC)&#10;Windows PowerShell feature that uses script files stored on a central server to apply, monitor, and maintain a specific configuration&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 26'
[feature]: #upgrade-and-migration 'feature&#10;component smaller than a role&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 11'
[GVLK]: #upgrade-and-migration 'generic volume licensing key (GVLK)&#10;Can be used to configure KMS clients that are not KMS clients by default, like those with retail, MAK, or KMS host licenses&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 39'
[idempotency]: #upgrade-and-migration 'idempotency&#10;quality of scripts that can be applied repeatedly without generating errors&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 26'
[KMS]: #upgrade-and-migration 'Key Management Service (KMS)&#10;Client/server application that enables client computers to activate their license doperating system products by communicating with a KMS host computer on the local network (suitable for large networks).&#10;Requires a minimum of 25 workstations (ref Activation threshold) and uses TCP port 1688. KMS hosts create an SRV resource record on DNS to identify it.&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 35'
[LCM]: #upgrade-and-migration 'Local Configuration Manager (LCM)&#10;engine running on the client system that receives configurations from the DSC server and applies them to the target computer&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 26'
[MAK Independent]: #upgrade-and-migration 'MAK Independent&#10;each computer using the MAK must perform an individual activation with Microsoft over the Internet or by telephone&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 36'
[MAK Proxy]: #upgrade-and-migration 'MAK Proxy&#10;VMAT collects installation IDs from target computers, activates them all at once, then receives and deploys confirmation IDs from Microsoft back to targets&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 36'
[MAK]: #upgrade-and-migration 'Multiple activation key (MAK)&#10;Product key that can be used to activate multiple Windows systems (suitable for small networks).&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 35'
[migration]: #upgrade-and-migration 'migration&#10;clean installation on a new computer with old data transferred over&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 28'
[MMC snap-in]: #upgrade-and-migration 'MMC snap-in&#10;Windows administrative tools&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 25'
[MOF]: #upgrade-and-migration 'Management Object Format (MOF)&#10;file created for each computer specified in the `Node` block of a DSC script, as well as the associated file format; the actual scripts that are distributed to the DSC clients&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 27'
[network controller]: #upgrade-and-migration 'network controller&#10;Windows Server 2016 Datacenter edition feature that provides a central automation point for network infrastructure configuration, monitoring, and troubleshooting&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 6'
[node block]: #upgrade-and-migration 'node block&#10;component of DSC scripts that specify the names of computers to be configured (i.e. targets)&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 26'
[pull architecture]: #upgrade-and-migration 'pull architecture&#10;client computer LCM creates a scheduled task to retrieve MOF file from a Pull Server&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 27'
[Pull Server]: #upgrade-and-migration 'Pull Server&#10;client computers have LCM configured to pull from a Pull Server periodically, checking the local system for compliance&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 27'
[push architecture]: #upgrade-and-migration 'push architecture&#10;configured on the server&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 27'
[resource block]: #upgrade-and-migration 'resource block&#10;component of DSC scripts that specify settings or components and the values that configuration script should assign to them&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 26'
[role]: #upgrade-and-migration 'role&#10;predefined combinations of services in Windows Server 2016&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 11'
[S2D]: #storage-spaces-direct 'Storage Spaces Direct (S2D)&#10;Windows Server 2016 Datacenter edition feature that enables administrators to use relatively inexpensive drive arrays to create high-availability storage solutions, implementing JBOD&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 5'
[shielded virtual machines]: #upgrade-and-migration 'shielded virtual machines&#10;Windows Server 2016 Datacenter edition feature that provides VMs with protection from compromised administrators that have access to the Hyper-V host computer by encrypting the VM state and virtual disks&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 6'
[Storage Replica]: #server-storage 'Storage Replica&#10;Windows Server 2016 Datacenter edition feature that provides storage-agnostic, synchronous or asynchronous volume replication between local or remote servers, using SMBv3&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 6'
[upgrade]: #upgrade-and-migration 'upgrade&#10;installation performed in-place with existing data intact&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 27'
[VAMT]: #upgrade-and-migration 'Volume Activation Management Tool (VAMT)&#10;Collects installation IDs from target computers, sending them to Microsoft using a single connection and receiving confirmation IDs in return, which are deployed to targets.&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 35'
[Volume Activation Services]: #upgrade-and-migration 'Volume Activation Services&#10;Windows Server role that must be added before installing a KMS host&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 37'
[Volume Activation Tools]: #upgrade-and-migration 'Volume Activation Tools&#10;&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 37'
[Volume Licensing Services]: #upgrade-and-migration 'Volume Licensing Services&#10;Windows Server role that must be added before being able to use Active Directory-based activation&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 40'
[WDS]: #upgrade-and-migration 'Windows Deployment Services (WDS)&#10;Role included with Windows server 2016 which can deploy disk image files to clients on the network automatically.&#10;Used to deploy operating systems en masse.&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 11'
[Windows Hyper-V Server 2016]: #upgrade-and-migration 'Windows Hyper-V Server 2016&#10;Free hypervisor-only download that hosts VMs.&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 5'
[Windows Server 2016 Datacenter]: #upgrade-and-migration 'Windows Server 2016 Datacenter&#10;Edition that allows unlimited number of operating system environments or Hyper-V containers and includes Storage Spaces Direct, Storage Replica, shielded VMs, and a new networking stack with additional virtualization options&#10;Intended for large and powerful servers in a highly virtualized environment.&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 4'
[Windows Server 2016 Essentials]: #upgrade-and-migration 'Windows Server 2016 Essentials&#10;Edition that is limited to one OSE and a maximum of 25 users and 50 devices and excludes the Server Core installation option&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 5'
[Windows Server 2016 MultiPoint Premium Server]: #upgrade-and-migration 'Windows Server 2016 MultiPoint Premium Server&#10;Academic edition that enables multiple users to access a single server installation&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 5'
[Windows Server 2016 Standard]: #upgrade-and-migration 'Windows Server 2016 Standard&#10;Edition that allows for two operating system environments, but lacks the storage and networking features included in Datacenter.&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 5'
[Windows Storage Server 2016]: #upgrade-and-migration 'Windows Storage Server 2016&#10;Bundled as part of a dedicated storage hardware solution&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 5'

[Windows Server Migration Tools]: #upgrade-and-migration 'Windows Server Migration Tools&#10;Five Windows Powershell cmdlets that enable administrators to migrate certain roles between servers&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 33'
[SmigDeploy.exe]: README.md#smigdeploy.exe '```&#10;C:\>SmigDeploy.exe&#10;```&#10;Create a new folder in specified directory, registering Windows Server Migration Tools on the source server and opening a Powershell window in which they can be used&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 34'

Windows Server 2016 installations are determined by the installation method ([upgrade][upgrade], [migration][migration], or clean installation), installation option (Desktop Experience, Server Core, or Nano Server) and edition ([Standard][Windows Server 2016 Standard], [Essentials][Windows Server 2016 Essentials], [Multipoint Premium][Windows Server 2016 MultiPoint Premium Server], [Storage][Windows Storage Server 2016], [Hyper-V][Windows Hyper-V Server 2016], and Datacenter) most suitable.
Windows Server 2016 [Datacenter][Windows Server 2016 Datacenter] edition features not available in other editions include: [Storage Spaces Direct][S2D], [Storage Replica][Storage Replica], [Shielded VMs][shielded virtual machines], and [network controller][network controller].
Installing the Windows Server 2016 Server Core foregoes the possibility of later switching back to Desktop Experience, as had been possible in previous editions. 
Configuring Server Core requires the command-line or [Powershell](pwsh.md#configure-server-core), including installation of [roles][role] and [features][feature]. <sup>[pwsh][Install-WindowsFeature]</sup>

Server Core installations can be managed with a GUI with the use of [MMC snap-ins][MMC snap-in]. 
Because MMC is reliant on [DCOM][DCOM], the firewall has to be [opened](pwsh.md#set-netfirewallrule "Set-NetFirewallRule").

IaaS management of servers is possible with [idempotent][idempotency] [DSC][DSC] scripts. DSC components include the [LCM][LCM] and [node][node block] and [resource][resource block] blocks. DSC configurations can be deployed in [push][push architecture] or [pull][pull architecture] **refresh modes** which are distinguished primarily by the manner in which [MOF][MOF] files are treated. 

Pull architectures depend on a [Pull Server][Pull Server] to consolidate MOF files, and individual client nodes "pull" their specific configuration script from it. 
Push architectures depend on running [`Start-DscConfiguration`](pwsh.md#start-dscconfiguration "Start-DscConfiguration") on the control server to "push" the configuration to each client.

Pull                | Push
---                 | ---
![](img/pullmodel.png)  | ![](img/pushmodel.png)

Migrations are facilitated by [Powershell][Windows Server Migration Tools] and [command prompt][SmigDeploy.exe] tools

Server installations are also influenced by choice of activation model. 
[MAK][MAK] is suitable for small networks, but large enterprises may opt for [KMS][KMS] or [Active Directory-based activation][Active Directory-based activation].
MAK activations are subdivided into [Independent][MAK Independent] and [Proxy][MAK Proxy], based on whether or not a [VAMT][VAMT] is used.
KMS activations, which distribute [GVLK][GVLK]s, are valid for a [period of time][Activation validity interval] and require the installation of a [role][Volume Activation Services] and [management tools][Volume Activation Tools].
KMS operates on TCP port 1688.
Finally, [AVMA][AVMA] simplifies the process of activating Hyper-V VMs running Windows Server 2012 or 2016.
#### Nano Server
[Nano Server]: #nano-server 'Nano Server&#10;Headless Windows Server installation option with no local user interface, no 32-bit application support, and only basic configuration controls. Administration requires remote WinRM connections and WMI tools&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 42'
[Nano Server Recovery Console]: #nano-server 'Nano Server Recovery Console&#10;Text-based interface that provides minimal controls needed to configure remote administration client capabilities of a Nano Server system.&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 50'
[Powershell Core]: #nano-server 'Powershell Core&#10;subset of Powershell Desktop, omitting many of its features&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 57'

[Nano Server][Nano Server], a new installation option introduced in Windows Server 2016, provides a much smaller footprint and attack surface than even Server Core, but supports only some roles and features.
Installation is done by [building a VHD image][New-NanoServerImage] on another computer, which is then deployed as a VM or used as a boot drive for a physical server.
The Windows Server 2016 installation media contains a NanoServer directory, from which the `nanoserverimagegenerator` Powershell module must be imported.
It also contains a Packages subdirectory, with CAB files containing roles and features that correspond to named parameters or packages that are specified as values to the `Packages` named parameter when building a Nano Server image.

Booting a Nano Server VM produces a [terminal-based][Nano Server Recovery Console] menu system that allows configuration of static network options (DHCP is enabled by default).
The DNS server may not be configured interactively, but must be specified when building the image with the `Ipv4Dns` parameter.

If a Nano Server is domain-joined a remote Powershell session will authenticate via Kerberos. If not, its name or IP address must be added to the Trusted Hosts list.
#### Images
Many enterprises have begun virtualizing their server environments to take advantage of the many cost, reliability, and performance benefits that this change creates.
Migrations should start with systems that are peripheral to main business interests before moving on to those that are more vital.
A carefully documented protocol should be developed to facilitate the conversion of physical hard disks to VHDs for use in Hyper-V guests.
Supported guest OSes include Linux and FreeBSD.

The **Microsoft Assessment and Planning (MAP) Toolkit** is a free software tool that intelligently constructs a database of the hardware, software, and performance of computers on a network to plan for an operating system upgrade or virtualization.
MAP supports the following discovery methods:
- Active Directory Domain Services
- Windows networking protocols
- System Center Configuration Manager
- IP address range scanning
- Computer names entered manually or imported from a file

Server Core relies on the [command-line](pwsh.md#update-server-core-image "Update Server Core image") for system maintenance, including updates which must be installed directly to the image using [`dism.exe`][dism.exe] or equivalent Powershell commands.
### Storage
#### Disks and volumes
[block]: #disks-and-volumes 'allocation unit (block)&#10;smallest amount of disk space that the computer can allocate when storing a file (sometimes incorrectly called a "sector")&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 82'
[sector]: #disks-and-volumes 'sector&#10;subdivision of a track, traditionally 512 bytes (Advanced Format disks use 4,096-byte sectors)&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 82'
[slack space]: #disks-and-volumes 'slack space&#10;space left over when a file occupies only part of a block&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 82'
[VHD]: #disks-and-volumes 'VHD&#10;"Virtual Hard Disk", virtual hard disk image format and file name extension supported by Windows Server.&#10;VHD images are limited to a maximum size of 2 TB and are compatible with servers running Windows Server 2008 or later, or workstations running Windows 7 or later.&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 88'
[VHDX]: #disks-and-volumes 'VHDX&#10;Newer hard disk image format and file name extension.&#10;VHDX image files can be as large as 64 TB, and they also support 4 KB logical sector sizes to provide compatibility with 4 KB native drives. VHDX files can be read only by servers running Windows Server 2012 or later or workstations running Windows 8 or later.&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 88'
[NTFS]: #disks-and-volumes 'NT File System (NTFS)&#10;Default file system for Windows Server since 1993.&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 93'
[ReFS]: #disks-and-volumes 'Resilient File System (ReFS)&#10;New file system that uses checksums to protect volume metadata and supports the same system of permissions as NTFS; intended for use in Storage Spaces pools.&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 94'
[MBR]: #images 'Master Boot Record (MBR)&#10;Older partition table type introduced in 1983 that is still common, despite its limitations.&#10;MBR partitions supports volumes up to 2 TB in size with up to 4 primary partitions.&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 85'
[GPT]: #images 'GUID partition table (GPT)&#10;Newer partition table type, introduced in the late 1990s, but not supported in Windows prior to Windows Server 2008 and Windows Vista.&#10;The GPT specification supports an unlimited number of partitions on volumes up to 18 exabytes.&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 86'

Every track of a hard drive platter is split into disk [sectors][sector], traditionally 512 bytes.
A [block][block] is commonly called an "allocation unit" in Windows, but also commonly called a cluster.
Storage left over unused in partially unused [blocks][block] is known as [slack space][slack space].

A new disk must first be **initialized**, that is, a **partition table** style must be chosen:
- [GPT][GPT]: 128 partitions per disk, maximum volume size of 18 exabytes (2<sup>60</sup> bytes). Booting from a GPT drive is not possible  unless the computer architecture supports EFI-based boot partitions.
- [MBR][MBR]: older format that is commonly used for removable media, supporting volumes up to 2 TB with up to 4 **primary partitions**, although a common workaround is to make one of these partitions an **extended partition**, which can be be further subdivided into logical drives

**Virtual hard disks** can be created with [Powershell][New-VHD] or in `diskmgmt.msc` and come in two formats:
- [VHD][VHD]
- [VHDX][VHDX]

Only 2 filesystem options are available for modern servers:
- [NTFS][NTFS] supports volumes up to 16 TB with the default 4 KB allocation unit size (but 256 TB with the 64 KB allocation unit size) and is required by some Windows Server services like **AD DS**, **File Replication Service**, **Volume Shadow Copy Service**, and **Distributed File System**
- [ReFS][ReFs] uses the same system of permissions as NTFS and offers error checking and repair capabilities that NTFS does not, but it does not support NTFS features like file compression, **Encrypted File System**, and disk quotas. ReFS supports a maximum file size of 16 exabytes and volumes up to **1 yobibyte** (2<sup>80</sup> bytes)

Windows Server 2016 supports file shares via two protocols, both of which require the `fs-fileserver` role service:
- **SMB**, long the standard for Windows networks
- **NFS**, typically used in Linux, requires the installation of `fs-nfs-service` role service

Software RAID can be implemented by creating **Spanned**, **Striped**, or **RAID-5** volumes in `diskmgmt.msc`.
A more modern and preferred technique is to create **storage pools** in  [Storage Spaces][Storage Spaces].

###### Partition vs. volume
Mounting a **partition** as a single filesystem produces a **volume**, although the distinction can often be lost.
The exception would be a case where a volume spans multiple partitions or physical disks, as is possible with software RAID.

#### Server storage
[Storage Spaces]: #server-storage 'Storage Spaces&#10;disk virtualization technology that enables a server to combine the storage space from individual physical disks and allocate that space to create virtual disks of any size supported by the hardware.&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 123'
[DCB]: #server-storage 'datacenter bridging (DCB)&#10;IEEE standards that define mechanisms for flow control and bandwidth management on a network with multiple traffic types&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 143'
[thinly provisioned]: #server-storage 'thinly provisioned&#10;virtual disk with a maximum size larger than that of currently available storage space&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 126'
[Simple fault tolerance]: #server-storage 'Simple fault tolerance&#10;Data is striped across all of the physical disks in the pool with no fault tolerance&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 127'
[Mirror fault tolerance]: #server-storage 'Mirror fault tolerance&#10;Data is written to two or three physical disks, so that a copy is always immediately available in case of failure.&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 127'
[Parity fault tolerance]: #server-storage 'Parity fault tolerance&#10;Data is striped across 3 or more physical disks in the pool along with parity information, which allows reconstruction of data if a physical disk fails&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 128'
[hot spare]: #server-storage 'hot spare&#10;disk that is part of the pool, but its space is not used until a disk failure occurs&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 130'
[tiered storage]: #server-storage 'tiered storage&#10;Storage Spaces feature that enables administrators to use their higher-performance storage devices for their most commonly used files&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 131'

[iSCSI]: #server-storage 'Internet Small Computer System Interface (iSCSI)&#10;SAN technology that enables servers and storage devices to exchange SCSI traffic over an IP network, rather than the more expensive Fibre Channel&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 133'
[iSCSI initiator]: #server-storage 'iSCSI initiator&#10;hardware or software device running on a computer that accesses the storage devices on the SAN and takes the place of the host adapter that traditional SCSI implementations used to connect storage cdevices to a computer&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 133'
[iSCSI target]: #server-storage 'iSCSI target&#10;receives SCSI commands from the initiator and passes them to a storage device, represented by a logical unit number (LUN)&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 134'
[HBA]: #server-storage 'host bus adapter (HBA)&#10;hardware iSCSI initiator, taking the form of an expansion card that includes the functionality of a SCSI host adapter and a Gigabit Ethernet network adapter in one device&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 134'

[iSNS]: #server-storage 'Internet Storage Name Service (iSNS)&#10;Registers the presence of iSCSI initiators and targets on a network and responds to queries from iSNS clients&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 140'
[CNA]: #server-storage 'Converged Network Adapter (CNA)&#10;Combination device that includes Ethernet networking capabilities, a SAN host bus adapter supporting iSCSI, FCoE, or a combination of SAN types.&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 143'
[traffic class]: #server-storage 'traffic class&#10;separate types of traffic on a converged network&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 144'
[PFC]: #server-storage 'Priority-based Flow Control (PFC)&#10;method of regulating network traffic to provide lossless data transmissions, as defined by one of the DCB standards&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 145'
[MPIO]: #server-storage 'Multipath I/O (MPIO)&#10;Windows Server 2016 feature that enables a server connected to iSCSI, Fibre Channel, or SAS SAN devices to revert to an alternate path through the network when a connection fails&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 145'

[asymmetric cluster]: #server-storage 'asymmetric cluster&#10;Also "stretch cluster", cluster nodes are divided between two sites, each with its own storage.&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 149'

[Storage Spaces][Storage Spaces] can create **storage pools** spanning many drives, from which **virtual disks** (not to be confused with VHD or VHDX files) can be formed.
Fault tolerance of a storage space can be improved by choosing between [Simple][Simple fault tolerance], [Parity][Parity fault tolerance], or [Mirror][Mirror fault tolerance] **layout options**.
Mirror provides better read/write performance than parity.
Individual physical disks can also be configured as [hot spares][hot spare].
If the virtual disk is formatted as **[ReFS][ReFS]**, it can be [thinly provisioned][thinly provisioned] as well.
Storage Spaces also has a featured called [tiered storage][tiered storage], which allows higher-performance devices to be reserved for more commonly used files.

Most modern SANs are based on [iSCSI][iSCSI], and iSCSI devices are of two types: [initiators][iSCSI initiator] that receive I/O requests from the operating system and [targets][iSCSI target] that receive SCSI commands and pass them to storage devices.
Windows Server 2016 includes the **iSCSI Target Server** role service, which allows a drive on one server to be designated as target to the initiator (installed by default) on another computer.
[iSNS][iSNS] facilitates the connection between initiator and target and sees the most use in enterprise networks.
iSNS architecture consists of a **server**, **database**, **clients**, and the **iSNS Protocol (ISNSP)**.

Because the collisions that are typical in Ethernet networks drastically affect the performance of SANs, their traffic is usually isolated from that of other networks.
Windows Server 2016 includes [DCB][DCB] as an installable feature, although a server must have [compatible hardware][CNA].
You can [configure][New-NetQosTrafficClass] up to 8 total [traffic classes][traffic class], and a [PFC][PFC] [for each][Enable-NetQosFlowControl].
[Multipath I/O][MPIO] is an installable feature that requires redundant network components and a device specific module (DSM) on every network adapter or host bust adapter that connects to the SAN.

[Storage Replica][Storage Replica] supports one-way replication between standalone servers, between clusters, and between storage devices within an [**asymmetric (stretch) cluster**][asymmetric cluster].
- **Synchronous** replication is possible when the replicated volumes can mirror data immediately, ensuring no data loss in case of failover
- **Asynchronous** replication is preferable when the replication partner is located over a WAN link

Storage Replica improves on DFS Replication, which is exclusively asynchronous and file-based, by using SMBv3 (port 445).
Storage Replica requires two virtual disks, one for logs and one for data, which are the same size for each replication partner, and all the physical disks must use the same sector size.
#### Data deduplication
[Data deduplication]: # 'Data deduplication&#10;role service in Windows Server 2016 that conserves storage space on an NTFS volume by locating redundant data and storing only one copy of that data instead of multiple copies; ReFS support was introduced with Windows Server version 1709&#10;Data deduplication replaces the earlier Single Instance Store (SIS) technology in earlier versions of Windows Server.&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 155'
[chunk store]: # 'chunk store&#10;separate area of the disk where unique chunks are kept&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 158'
[reparse point]: # 'reparse point&#10;special tag that replaces the location of a chunk that already exists in the store&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 158'
[churn]: # 'churn&#10;accumulation of unoptimized files due to the workload of the volume&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 158'
[garbage collection]: # 'garbage collection&#10;job that searches the chunk store for chunks that no longer have reparse points associatd with them, typically due to modified or deleted files&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 158'
[integrity scrubbing]: # 'integrity scrubbing&#10;job that searches for damage or corruption in the chunk store, replacing missing data with mirror or parity data&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 158'
[unoptimization]: # 'unoptimization&#10;job that restores all of the optimized files on a volume to their original states, disabling Data Deduplication for that volume in the process&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 159'

[Data deduplication][Data deduplication], once [installed][Install-WindowsFeature], runs as a low-priority background process when the system is idle, by default; however its behavior can be [configured][Enable-DedupVolume] based on its intended usage.
Deduplication works by scanning files, and breaking them into unique **chunks** of various sizes that are collected in a [chunk store][chunk store].
The original locations of chunks are replaced by [reparse points][reparse point].
When a file is recently written, it is written in the standard, unoptimized form; the accumulation of such files is known as [churn][churn].
Other jobs associated with deduplication include [garbage collection][garbage collection], [integrity scrubbing][integrity scrubbing], and (when disabling deduplication) [unoptimization][unoptimization].

Deduplication is especially useful for disk drive backups, since snapshots typically differ little from each other.
### Hyper-V
#### Hyper-V configuration
[Hyper-V]: # 'Hyper-V&#10;Windows Server 2016 role and Type 1 Hypervisor&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 165'
[partition]: # 'partition&#10;individual environments created by hypervisor, each of which has its own operating system installed and accesses the computer\'s hardware via the hypervisor&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 167'
[Sconfig]: # 'Sconfig&#10;script-based configuration interface for Hyper-V Server&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 168'
[explicit remoting]: # 'explicit remoting&#10;opening a temporary or persistent Powershell session to a remote system&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 176'
[implicit remoting]: # 'implicit remoting&#10;running a cmdlet specifying the `ComputerName` parameter, which directs its function to the remote system&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 177'
[PowerShell Direct]: # 'PowerShell Direct&#10;a means of connecting to a Hyper-V guest operating system from the host operating system, using a PowerShell session&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 180'
[Nested virtualization]: # 'Nested virtualization&#10;ability to configure a Hyper-V guest VM to function as a Hyper-V host&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 181'
[CredSSP]: #hyper-v-configuration 'Credential Security Support Provider (CredSSP)&#10;Authentication protocol used as an alternative to Kerberos when trying to establish a Powershell remoting session between two hosts not in the same domain or forest.&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 176'

[Hyper-V][Hyper-V] is a Type I hypervisor and role that allows a Windows Server 2016 **host** to create VMs, called **guests**.
In Type I virtualization, the hypervisor forms an abstraction layer that interacts directly with the host hardware.
In this model, the individual environments created by the hypervisor, including the host operating system and guest VMs, are called [partitions][partition].

Hyper-V Server, a free product available for download is limited to the command-line Server Core interface, however it does include [`Sconfig`][Sconfig] to aid configuration.

Hyper-V can be managed remotely using the GUI (Hyper-V Manager, `hyper-v-tools`), or Powershell (`hyper-v-powershell`).
Authentication can be via Kerberos or [CredSSP][CredSSP], which must be [enabled](pwsh.md#enable-credssp "Enable CredSSP") on both server and client.
Powershell remoting in turn, can be [explicit][explicit remoting] or [implicit][implicit remoting].
[PowerShell Direct][PowerShell Direct] allows easy remoting to VMs by using the `-VmName` Powershell parameter.

[Nested virtualization][Nested virtualization] is a new capability where a virtual host running Windows Server 2016 on a physical host also running Windows Server 2016 can host nested VMs, after some [configuration](pwsh.md#implement-nested-virtualization "Implement nested virtualization").
#### VM configuration
[Dynamic memory]: #vm-configuration 'Dynamic memory&#10;Hyper-V feature that automatically allocates memory to and deallocates it from VMs as needed&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 186'
[NUMA]: #vm-configuration 'Non-Uniform Memory Access (NUMA)&#10;system architecture used to increase memory efficiency in computers with multiple processors by dividing logical processors and memory into NUMA nodes, with each node containing one or more logical processors and the region of memory closest to them&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 189'
[NUMA ratio]: #vm-configuration 'NUMA ratio&#10;difference between accessing local and remote memory for any processor&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 189'
[Smart paging]: #vm-configuration 'Smart paging&#10;Hyper-V feature that enables the host server to compensate when its memory is overcommitted by using disk space for memory paging only during the boot sequence&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 192'
[Resource metering]: #vm-configuration 'Resource metering&#10;Hyper-V feature that makes it possible to track the resources a VM uses as it operates&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 193'
[DDA]: #vm-configuration 'Discrete Device Assignment (DDA)&#10;Hyper-V feature that enables passthrough of any PCI Express device, including GPUs or network adapters&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 212'
[Integration Services]: #vm-configuration 'Integration Services&#10;software package containing drivers and other components that runs on a guest operating system, enabling it to communicate with the Hyper-V host server&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 195'
[LIS]: #vm-configuration 'Linux Integration Services (LIS)&#10;Linux driver for Hyper-V specific devices&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 204'
[Secure Boot]: #vm-configuration 'Secure Boot&#10;UEFI feature that ensures components loaded during the boot sequence have been digitally signed, and therefore trusted by the computer manufacturer&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 205'
[Enhanced session mode]: # 'Enhanced session mode&#10;Hyper-V feature available when the host and guest are both running a recent version of Windows, whereby a VM being accessed through VMConnect can utilize resources on the host.&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 200'

VMs are associated with a variety of file type including XML-format VM configuration (.vmc), virtual hard disk (.vhd and .vhdx), and saved-state (.vsv) files.
VMs can be [created][New-VM] in Hyper-V, and a machine's RAM can even be [changed][Set-VMMemory] [dynamically][Dynamic memory].

Hyper-V guests can take advantage a suite of features to enhance performance and functionality.
- Virtualization of [NUMA][NUMA] architecture
- [Smart paging][Smart paging] for when VMs that use dynamic memory restart and temporarily need more memory than is available on the host, for example at boot
- [Monitoring][resource metering] resource usage, to minimize cost overruns when guests run in the cloud
- Disk and GPU passthrough, and other PCI-x devices, with [DDA][DDA] <sup>[pwsh](pwsh.md#implement-dda)</sup>
- [Increased performance][Enhanced session mode] of interactive sessions that use [VMConnect][VMConnect.exe]

Microsoft supports some Linux distributions, like Ubuntu, with built-in [Linux][LIS] [Integration Services][Integration Services], which improve performance by providing custom drivers to interface with Hyper-V.
Some distributions like CentOS and Oracle come with integrated LIS packages, but free LIS packages provided by Microsoft for download from the Microsoft Download Center support additional features and come with the additional benefit of being versioned.
These packages are provided as tarballs or ISO images, and must be loaded directly into the running guest operating system.
FreeBSD has included full support for FreeBSD Integration Services (BIS) since version 10.

[Secure Boot][Secure Boot] has to be disabled when loading Hyper-V VMs running Linux distributions, since UEFI does not have certificates for non-Windows operating systems by default. 
Some distributions supported by Microsoft do have certificates in the [UEFI Certificate Authority][Set-VMFirmware].

Different versions of Hyper-V create VMs associated with that version (Windows Server 2016 uses Hyper-V 8.0).
VMs created by older versions of Hyper-V can be [updated][Update-VMVersion], but once updated they may no longer run on a host of a previous version.

Importing an exported VM can be done in three ways: 
- **Register**: exported files are left as-is and the guest's ID is maintained; 
- **Restore**: exported files copied to the host's default locations or ones that are otherwise specified; ID is maintained
- **Copy**: exported files are copied; new ID generated
#### Hyper-V storage
[checkpoint]: #hyper-v-storage 'checkpoint&#10;Captured image of the state, data, and hardware configuration of a virtual machine at a specific moment in time.&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 228'
[production checkpoint]: #hyper-v-storage 'production checkpoint&#10;Feature of Windows Server 2016 Hyper-V that uses the Volume Shadow Copy Service in Windows or File System Freeze in Linux to create a snapshot of the data of a VM without saving memory state.&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 230'
[differencing disk]: #hyper-v-storage 'differencing disk&#10;Paired with a baseline virtual disk image to preserve it in its original state.&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 223'
[VHD set]: #hyper-v-storage 'VHD set&#10;Shared virtual drive option new in Windows Server 2016, that allows resizing, migration, backup, and replication from the host server, none of which are possible with shared VHDX files.&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 222'
[pass-through disk]: #hyper-v-storage 'pass-through disk&#10;virtual disk that points to a virtual disk&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 225'


The New Virtual Machine Wizard presents different options for Generation 1 vs. Generation 2 VMs.
- **Generation 1** VMs provide two IDE controllers, which host the hard drive and a DVD drive, and an unpopulated SCSI controller which can host additional disks.
- **Generation 2** VMs, however, have only a single SCSI controller, which hosts all virtual drives.

A new VHD can be created using 
- Hyper-V Manager through the New Virtual Hard Disk Wizard
- Disk Management (`diskmgmt.msc`), however the option to create a [differencing][differencing disk] disk is not available, nor can specific block or sector size be specified
- PowerShell

Shared virtual disk files are preferably created as [VHD sets][VHD set].
[Pass-through][pass-through disk] disks make exclusive use of a physical disk. <sup>[pwsh](pwsh.md#pass-through-disk)</sup>

[**Standard checkpoints**][checkpoint] (previously known as "snapshots" in Windows Server 2012 and before) with the extensions AVHD or AVHDX are recommended for development and testing but are not a replacement for backup software nor recommended for production environments.
Because standard checkpoints save the memory state of all running applications, restoring them in a production environment will interrupt running services.
[**Production checkpoints**][production checkpoint] do not save memory state.
#### Hyper-V networking
<!-- Concepts -->
[external virtual switch]: #hyper-v-networking 'external virtual switch&#10;bound to networking protocol stack in the host operating system and connected to a physical network interface adapter on the host, allowing VMs to access the network to which the physical adapter is connected&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 241'
[internal virtual switch]: #hyper-v-networking 'internal virtual switch&#10;Bound to a separate instance of the networking protocol stack in the host operating system, independent from the physical network interface adapter and its connected network, it allows VMs to access the virtual network, including the host operating system.&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 241'
[legacy network adapter]: #hyper-v-networking 'legacy network adapter&#10;Also "emulated network adapter", one of two types of virtual network adapter supported by Generation 1 VMs in Hyper-V, which makes calls directly to the hypervisor.&#10;Generation 1 VMs could not boot from PXE without a legacy network adapter, however their performance is worse than that of synthetic network adapters.&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 248'
[Microsoft Network Adapter Multiplexor Driver]: #hyper-v-networking 'Microsoft Network Adapter Multiplexor Driver&#10;Network component installed after configuring a NIC team in Window Server 2016&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 249'
[private virtual switch]: #hyper-v-networking 'private virtual switch&#10;Exists only in the Hyper-V server and is accessible only to the VMs running on it, and is inaccessible to the host operating system itself.&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 241'
[RDMA]: #hyper-v-networking 'Remote Direct Memory Access (RDMA)&#10;network adapter technology and network transmission method that can send large amounts of data with low latency and without processor intervention&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 253'
[SET]: #hyper-v-networking 'Switch Embedded Teaming (SET)&#10;Hyper-V-only variation of NIC teaming that is implemented wholly within a virtual switch&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 253'
[synthetic network adapter]: #hyper-v-networking 'synthetic network adapter&#10;One of two types of virtual network adapter supported by Generation 1 VMs in Hyper-V, which does not correspond to a real-world product.&#10;Hyper-V synthetic network adapters communicate with the host operating system through the VMBus&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 247'
[VMQ]: #hyper-v-networking 'Virtual Machine Queue (VMQ)&#10;Network performance enhancement feature enabled by Windows Server 2016 automatically when it detects physical network adapters that run at 10 Gbps or faster. &#10;Physical network adapter that support VMQ filters inbound packets based on the destination address and then forwards queues for each to the host operating system&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 251'
[LACP]: # 'Link Aggregation Control Protocol (LACP)&#10;common aggregation protocol that allows multiple physical ports to be bound together&#10;Dulaney, Emmett. _CompTIA Network+ N10-007 Exam Cram, 6th Edition_.: 121'


<!-- Powershell cmdlets-->
[Enable-NetAdapterRdma]: #enable-netadapterrdma '```&#10;PS C:\> Enable-NetAdapterRdma&#10;```&#10;Enable RDMA on adapters&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 254'
[Enable-NetAdapterVmq]: #enable-netadaptervmq '```&#10;PS C:\> Enable-NetAdapterVmq&#10;```&#10;Enable VMQ on a specific adapter&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 252'
[Get-NetAdapterRdma]: #get-netadapterrdma '```&#10;PS C:\> Get-NetAdapterRdma&#10;```&#10;Display the current RDMA status of network adapters&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 254'
[Get-NetAdapterVmq]: #get-netadaptervmq '```&#10;PS C:\> Get-NetAdapterVmq&#10;```&#10;Discover whether physical network adapters support VMQ&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 252'
[Get-NetAdapterVmqQueue]: #get-netadaptervmqqueue '```&#10;PS C:\> Get-NetAdapterVmqQueue&#10;```&#10;See which VMQ queries are assigned to which processors&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 252'
[Set-NetAdapterVmq]: #set-netadaptervmq '```&#10;PS C:\> Set-NetAdapterVmq&#10;```&#10;Modify default VMQ settings&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 253'

Virtual switches can be [external][external virtual switch], [internal][internal virtual switch], or [private][private virtual switch] (in order of decreasing access).
Up to 8 network adapters can be [added][Add-VMNetworkAdapter] to a Windows Server 2016 Hyper-V VM.

Hyper-V maintains a pool of MAC addresses which are assigned to virtual network adapters as they are created.
Hyper-V MAC addresses begin with `00-15-5D`, followed by the last two bytes of the IP address assigned to the server's physical network adapter (i.e. last two octets), then a final byte.

Generation 1 VMs supported [synthetic][synthetic network adapter] and [legacy][legacy network adapter] virtual network adapters, but in Generation 2 VMs only synthetic adapters are used.
Generation 1 VMs can only boot from network (PXE) when using a legacy adapter.

Physical hosts running Windows Server 2016 can support teams of up to 32 NICs, but Hyper-V VMs are limited to teams of two.
The team must first be configured in the host operating system and appears as a single [interface][Microsoft Network Adapter Multiplexor Driver] in the Virtual Switch Manager.
High-performance [embedded teaming][SET], reliant on [RDMA][RDMA], can only be configured with [Powershell](pwsh.md#create-a-virtual-switch-with-set-enabled).
- **Teaming Mode** 
  - **Switch Independent**: switch is unaware of presence of NIC team and does not load balance to members
  - **Switch Dependent**: switch determines how to distribute inbound network traffic
    - **Static Teaming**: switch and host are manually configured (typically supported by server-class switches)
    - [**Link Aggregation Control Protocol (LACP)**][LACP]: dynamically identifies links that are connected between the host and the switch
- **Load Balancing Mode**
  - **Address Hash**: a hash is created based on address components of the packet, which is used to reasonably balance adapters
  - **Hyper-V Port**: NIC teams configured on Hyper-V hosts give VMs independent MAC addresses
  - **Dynamic**: outbound loads are distributed based on a hash of the TCP ports and IP addresses

[Virtual machine queuing][VMQ] will enhance performance if a physical host [supports][Get-NetAdapterVmq] it and it is [enabled][Enable-NetAdapterVmq].

Bandwidth management is achieved by setting limits on the virtual network adapter, in the GUI or in [Powershell][Set-VMNetworkAdapter].
### Windows containers
#### Container deployment
Containers run applications in an **isolated namespace**, meaning it only has access to resources that are made available to it by the container runtime.
**Resource governance** means that a container has access only to a specified number of processor cycles, system memory, and other resources.
Containers allow applications to be packaged with their dependencies in **container images**, which will run the same regardless of underlying operating system or infrastructure and are downloaded from **container registries** like **Docker Hub**.
Container registries are not to be confused with **repositories**, which are subcomponents of registries.
Windows Server 2016 suports **Windows Server Containers** and **Hyper-V Containers**, which create a separate copy of the operating system kernel for each container.

The "Containers" feature must be installed on Windows Server 2016 hosts, and to create Hyper-V containers the Hyper-V role must also be installed (although the Hyper-V management tools are not necessary if VMs are not going to created).

Nano Server once could serve as Docker hosts, but no longer; Nano Servers are now intended to be deployed as containers themselves.
The [Powershell Docker module](https://github.com/microsoft/Docker-PowerShell "PowerShell for Docker") has been deprecated for years.

#### Container management
### Clusters
#### High availability
[Hyper-V Replica]: #high-availability 'Hyper-V Replica&#10;feature of the Hyper-V role that allows creation of a replica of VMs on a Hyper-V server to another server, locally or remote&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 297'
[replica server]: #high-availability 'replica server&#10;term used to designate the destination server in a failover solution&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 299'
[Shared Nothing Live Migration]: #high-availability 'Shared Nothing Live Migration&#10;migration of VM data, memory, and system state to another host&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 307'
[Live Migration]: #high-availability 'Live Migration&#10;migration of VM state and live memory contents to another host, but not its data&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 303'
[Storage Migration]: #high-availability 'Storage Migration&#10;migration of VM virtual hard disk files to another host, but not its memory and system state&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 371'
[site-aware failover cluster]: #high-availability 'site-aware failover cluster&#10;Contains fault domains based on the values of a site property configured for each node, which are used to determine its behavior during failovers and other role transfers&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 366'
[failover affinity]: #high-availability 'failover affinity&#10;Behavior of a site-aware failover cluster where failover occurs to a node at another site only when all the nodes in the original site are found to be unavailable&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 366'
[node fairness]: #high-availability 'node fairness&#10;Balances distribution of VMs on cluster nodes&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 366'


To configure a simple failover solution using [**Hyper-V Replica**][Hyper-V Replica], configure the **destination server** as a [replica][replica server]. <sup>[pwsh][Set-VMReplicationServer] [lab](#hyper-v-replica-lab)</sup>
On the VM that will be replicated, configure options through the **Enable Replication wizard**.

Migrations can take place one of three methods:
- [**Live Migration**][Live Migration] works by first creating an unpopulated VM on the destination with the same resources as the source before transferring memory pages. 
Once the servers have an identical memory state, the source VM is suspended and the destination takes over. 
Hyper-V  notifies the network switch of the change, diverting network traffic to the destination. 
When a Hyper-V cluster is created, the Failover Cluster Manager launches the High Availability Wizard, which configures the VM to support Live Migration. <sup>[pwsh][Add-ClusterVirtualMachineRole]</sup> 
Hyper-V hosts that are not clustered can still perform live migrations, but they must be part of the same (or trusted) domains.
- [**Shared Nothing Live Migration**][Shared Nothing Live Migration] requires that source and destination VMs be members of the same (or trusted) domain, and source and domain servers must be running the same processor family (Intel or AMD) and linked by an Ethernet network running a minimum of 1 Gbps. 
Additionally, both Hyper-V hosts must be running idential virtual switches that use the same name; otherwise the migration process will be interrupted to prompt the operator to select a switch on the destination server. 
The process of migrating is almost identical to a Live Migration, except that you select the "Move the Virtual Machine's Data To a Single Location" option on the Choose Move Options page of the Move Wizard.
- [**Storage Migration**][Storage Migration] works by first creating new VHDs on the destination corresponding to those on the source server.
While the source server continues to operating using local files, Hyper-V begins mirroring disk writes to the destination server and begins a single-pass copy of the source disks to the destination begins, skipping blocks that have already been copied.
Once the copy has completed, the VM begins working from the destination server and the source files are deleted.
For a VM that is shut off, storage migration is equivalent to simply copying files from source to destination.

An additional, outdated method of migration is **quick migration**, which was present in Windows Server prior to the introduction of live migration and persists in Windows Server 2016 for backward compatibility.
A quick migration involves pausing the VM, saving its state, moving the VM to the new owner, and starting it again.
A quick migration always involves a short period of VM downtime.

[Site-aware][site-aware failover cluster] clusters have [failover affinity][failover affinity].
[Node fairnes][node fairness] evalutes memory and CPU loads on cluster nodes over time.

#### Failover clustering
[failover cluster]: #high-availability 'failover cluster&#10;group of two or more computers, physical or virtual, running the same application that functions as a single entity to provide high availability, scalability, and fault tolerance&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 311'
[CNO]: #failover-clustering 'cluster name object (CNO)&#10;Computer object in Active Directory associated with a failover cluster&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 313'
[SoFS]: # 'Scale-Out File Server (SoFS)&#10;clustered role that is designed to provide highly available storage for applications, like Hyper-V and SQL Server&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 337'
[Add-ClusterScaleOutFileServer]: #add-clusterscaleoutfileserver '```&#10;PS C:\> Add-ClusterScaleOutFileServer&#10;```&#10;Install the Scale-out File Server role&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 339'
[guest failover cluster]: #failover-clustering 'guest failover cluster&#10;consists solely of VMs running on a single Hyper-V host server&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 341'
[witness]: #high-availability 'witness&#10;resource that casts a vote for the continued operation of a cluster&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 318'
[quorum]: #high-availability 'quorum&#10;provides each node and witness in a cluster with a vote, to prevent a cluster from developing split-brain&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 317'
[Active Directory-detached cluster]: #high-availability 'Active Directory-detached cluster&#10;Cluster whose nodes are joined to a domain but which is not associated with a cluster name object (CNO) in AD&#10;In such a cluster, the name of the cluster and nodes must be registered in DNS, but the nodes still must be joined to an AD DS domain.&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 337'

Computers in a [failover cluster][failover cluster] are called **nodes** and typically have a secondary network adapter, which must be configured with a static IP and a preferred DNS server, which is used for cluster communications.

A failover cluster can be single-domain, multi-domain, or workgroup clusters, depending on how or if the servers are joined to domains.
A cluster whose servers are joined to a single domain is typically associated with a [cluster name object][CNO] in Active Directory, which is called its **administrative access point**.
Some applications also create similar objects called **virtual computer objects (VCO)**, client access points.
A cluster can also be configured to be [detached][Active Directory-detached cluster] from AD, even though its nodes are joined, using the [`-AdministrativeAccessPoint dns`][New-Cluster] parameter.
Nodes that are domain member servers support CredSSP or Kerberos authentication.
Workgroup clusters support NTLM authentication only.

A single-domain cluster can use AD to provide access to all nodes, but in its absence the same local user account with the same username and password must be created on every node and added to Administrators.
The builtin Administrator account can work, but if a different account is used then a new Registry key must be [created][New-ItemProperty] on each node.

Three types of [witness][witness] resources can help to ensure a [quorum][quorum] takes place in clusters. A witness is created when a cluster has an even number of nodes, and only one can be configured. <sup>[pwsh][Set-ClusterQuorum]
- **Disk witness**: dedicated disk in shared storage that contains a copy of the cluster database
- **File Share witness**: SMB file share containing a Witness.log file with information about the cluster
- **Cloud witness**: blob stored in Azure

The [Scale-out File Server (SoFS)][SoFS] role is specifically recommended for use on Hyper-V and SQL Server clusters and can be installed with [`Add-ClusterScaleOutFileServer`][Add-ClusterScaleOutFileServer].
SoFS requires the **File Server role service** and the **Failover Clustering feature**
A [guest cluster][guest failover cluster] is good for learning about failover clustering.

VM resiliency can be configured by adjusting settings in response to changes in VM state:
- **Unmonitored**: VM owning a role is not being monitored by the Cluster Service
- **Isolated**: Node is not currently an active member of the cluster, but still possess the role
- **Quarantine**: Node has been drained of its roles and removed from the cluster for a specified length of time.
#### Storage Spaces Direct
[hyper-converged S2D scenario]: # 'hyper-converged S2D scenario&#10;combines S2D with Hyper-V in a single cluster&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 357'
[disaggregated S2D scenario]: # 'disaggregated S2D scenario&#10;has two distinct clusters: a Scale-out File Server cluster that uses S2D to provide the storage for the second, a Hyper-V cluster hosting VMs&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 355'

The recommended drive configuration for a node in an S2D cluster is a minimum of six drives, with at least 2 SSDs and at least 4 HDDs, with no RAID or other intelligence that cannot be disabled.
These disks must be initialized (typically using GPT), but **unpartitioned**.

Microsoft defined two deployment scenarios for [Storage Spaces Direct (S2D)][S2D]: [hyper-converged][hyper-converged S2D scenario] and [disaggregated][disaggregated S2D scenario].
The disaggregated scenario requires the [DCB][DCB] role for traffic management.
At least two 10Gbps Ethernet adapters are recommended per node, preferably adapters that use RDMA.

Creating a S2D cluster in Powershell requires the use of the [`-NoStorage`][New-Cluster] parameter, because you must prevent the system from automatically detecting and adding storage. <sup>[pwsh](pwsh.md#configure-s2d-cluster "Create a S2D cluster")</sup>
#### Moving cluster VMs
[quick migration]: #moving-cluster-vms 'quick migration&#10;move a running or stopped VM after what is usually a brief pause by first copying the memory of the VM to disk and then from the disk to the destination&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 370'

VMs can be moved from node to node of a cluster using [live][Live Migration], [storage][Storage Migration], or [quick][quick migration] migrations.
#### NLB
[drain on shutdown]: #nlb 'drain on shutdown&#10;feature of Windows Server 2016 Failover Clustering which automatically live migrates all roles on a node before shutting down the system&#10;Zacker, Craig. _Installation, Storage and Compute with Windows Server 2016: Exam Ref 70-740_. 2017: 374'

Cluster VMs can be configured to [move][drain on shutdown] their workloads to other nodes when being shutdown using `Suspend-ClusterNode`

NLB port rules control how the cluster functions, and is mainly defined by two operational parameters:
- **Affinity**: associate client requests to cluster hosts. When no affinity is specified, all network requests are load-balanced across the cluster without regard to their source.
- **Filtering mode**: specify how the cluster handles traffic described by port range and protocols; can be single or multiple hosts.
### Maintenance and monitoring
#### Maintenance

**Windows Server Update Services (WSUS)** can be configured from the command-line with [`wsusutil.exe`](README.md#wsusutil)

#### Monitoring
**Alerts** can be triggered when a **performance counter** value exceeds a certain threshold.
Only members of the local groups **Administrators** and **Performance Log Users** can create alerts, but the **Log on as a batch user** right must be granted to members of Performance Log Users.
# Labs
### Server Core
Configure VM
```powershell
Rename-VMSwitch Intel* External
New-VM PLABDMCORE02 1024 1 -SwitchName External -NewVHDPath 'D:\VHD\PLABDMCORE02\Virtual Hard Disks\PLABDMCORE02.vhdx' -NewVHDSize 127gb
Set-VMDvdDrive ... # Can't find way to pass through host drive Z:\ 
```
Add DVD drive Z: of host to VM's DVD drive (no Powershell equivalent found yet).
```powershell
Start-VM PLABDMCORE02
```
Install Windows, then continue configuring VM
```powershell
# PLABDMCORE02
Rename-Computer PLABDMCORE02
New-NetIpAddress 192.168.0.7 -PrefixLength 24 -InterfaceAlias Ethernet
Set-DnsClientServerAddress -InterfaceAlias Ethernet -ServerAddresses 192.168.0.1
Restart-Computer
```
Join computer to domain
```powershell
Add-Computer -DomainName practicelabs.com -DomainCredential practicelabs\administrator
Restart-Computer
```
Install packages remotely
```powershell
# PLABDC01
Enter-PSSession PLABDMCORE02
Add-WindowsFeature -Name dns,rsat-dns-server -IncludeManagementTools
```
Add PLABDMCORE02 as a DNS server while remotely connected to DC (no Powershell equivalent found yet).

Add a secondary lookup zone to PLABDMCORE02 (doesn't work; asks for Zonefile)
```powershell
Add-DnsServerSecondaryZone -Name practicelabs.com -MasterServers 192.168.0.1
```
### Nano Server
```powershell
# PLABDM01
Copy-Item Z:\NanoServer\NanoServerImageGenerator\*.ps* C:\nanoserver
Import-Module C:\nNanoserver\NanoServerImageGenerator.psm1
```
Create the VHD image
```powershell
New-NanoServerImage -Edition Standard -MediaPath z:\ -Basepath c:\nanoserver -Targetpath c:\nanoserver\PLABNANOSRV01.vhdx -DeploymentType Guest -ComputerName PLABNANOSRV01 -Storage -Package Microsoft-NanoServer-DNS-Package
Set-VMHardDiskDrive -VMName PLABNANOSRV01 -Path C:\nanoserver\PLABNANOSRV01.vhdx
```
### Windows Deployment Services

### DISM
```powershell
# PLABSA01 
Set-Location C:\
mkdir updates,images,mount,drivers
Copy-Item \\plabdm01\Win10\sources\install.wim C:\updates
(Get-Item C:\updates\install.wim).IsReadOnly = $false
```
Move specified .msu installers to C:\updates and uncompress device driver to C:\drivers

Using Powershell:
```powershell
Mount-WindowsImage -Path C:\mount -ImagePath C:\images\install.wim -Index 1
Add-WindowsPackage -Path C:\mount -PackagePath C:\updates 
Add-WindowsDriver -Path C:\mount -Driver C:\drivers\display.driver\nv_dispi.inf
Save-WindowsImage -Path C:\mount 
Dismount-WindowsImage -Path C:\mount -Save
```
Using `dism.exe`:
```cmd
dism /mount-wim /wimfile:c:\images\install.wim /index:1 /mountdir:c:\mount
dism /image:c:\mount /add-package /packagepath:c:\updates
dism /image:c:\mount /add-driver /driver:c:\drivers\display.driver\nv_dispi.inf
dism /commit-wim /mountdir:c:\mount
dism /unmount-wim /commit /mountdir:c:\mount
```
### NLB lab
Configure a **Network Load Balancing** cluster. <sup>[Practice Lab][pl:70-740]</sup>

```powershell
# PLABDM01 and PLABSA01
Install-WindowsFeature web-server, web-webserver, web-mgmt-tools -IncludeManagementTools

# PLABDM01
New-NetIpAddress 192.168.0.20 -PrefixLength 24 -InterfaceAlias Ethernet1

# PLABSA01
New-NetIpAddress 192.168.0.40 -PrefixLength 24 -InterfaceAlias Ethernet1
Install-WindowsFeature -Name nlb -IncludeAllSubFeature -IncludeManagementTools
```
Using the **Network Load Balancing Manager**, create a new cluster named **PLAB-NLB1** specifying **multicast** operation mode at 192.168.0.25, and create an appropriate DNS record on **PLABDC01**.

Install NLB on **PLABDM01** and add it to the cluster through the NLB Manager.
Edit the image located at `C:\inetpub\wwwroot\iisstart.png` on either server.
Once saved, these edits will now be visible when that server's website is visited at its hostname.
Copy the contents of `C:\inetpub\wwwroot` to new directory `C:\nlbport` on **PLABDM01**.
Host that directory as a website on port 6789, opening the firewall appropriately.
```powershell
New-Website -Name nlbport -PhysicalPath "c:\nlbport" -Port 6789
New-NetFirewallRule -DisplayName NLBPort -Protocol TCP -LocalPort 6789
```
Returning to the NLB Manager, open Cluster Properties > Port Rules and remove the single defined port rule.
Add a new port rule that specifies port 80 for "multiple host" filtering mode, and another that specifies port 6789 for "single host" filtering mode.
Then from the host-specific port rule dialog box, select a handling priority of 10.
### iSCSI Storage
Network topology
```powershell
# PLABDC01
New-NetIpAddress 192.168.0.10 -PrefixLength 24 -InterfaceAlias Ethernet2

# PLABDM01
New-NetIpAddress 192.168.0.20 -PrefixLength 24 -InterfaceAlias Ethernet1
New-NetIpAddress 192.168.1.20 -PrefixLength 24 -InterfaceAlias Ethernet2
Set-DnsClientServerAddress -InterfaceAlias Ethernet1,Ethernet2 -ServerAddresses 192.168.0.1
```
iSCSI target
```powershell
# PLABDC01
Add-WindowsFeature fs-iscsitarget-server -IncludeManagementTools
New-iSCSIVirtualDisk -SizeBytes 5gb -Path 'C:\CorporateHD.vhdx'
New-iSCSIServerTarget -TargetName plabdc01 -InitiatorId @('ipaddress:192.168.0.20','ipaddress:192.168.1.20')
Add-iSCSIVirtualDiskTargetMapping -Path 'C:\CorporateHD.vhdx' -TargetName plabdc01
```
iSCSI initiator
```powershell
# PLABDM01
Start-Service msiscsi
Get-NetFirewallServiceFilter -Service msiscsi | Get-NetFirewallRule | Enable-NetFirewallRule
Connect-iSCSITarget -NodeAddress (Get-iSCSITarget).NodeAddress
```
Multipath
...
Finally, mount the drive
```powershell
New-Volume -DiskNumber 5 -FriendlyName iSCSI-Volume1 -FileSystem NTFS -DriveLetter R
```
### Failover cluster lab
Network topology
```powershell
# PLABDM01
New-NetIpAddress 192.168.0.20 -PrefixLength 24 -InterfaceAlias Ethernet1
New-NetIpAddress 192.168.0.21 -PrefixLength 24 -InterfaceAlias "vEthernet (Internal network 1)"
New-NetIpAddress 192.168.1.20 -PrefixLength 24 -InterfaceAlias Ethernet2
Set-DnsClientServerAddresses Ethernet1,Ethernet2 -ServerAddresses 192.168.0.1
Disable-NetAdapter "vEthernet (Internal network 1)"

# PLABSA01
New-NetIpAddress 192.168.0.40 -PrefixLength 24 -InterfaceAlias Ethernet1
New-NetIpAddress 192.168.0.41 -PrefixLength 24 -InterfaceAlias "vEthernet (Internal network 1)"
New-NetIpAddress 192.168.1.40 -PrefixLength 24 -InterfaceAlias Ethernet2
Set-DnsClientServerAddress Ethernet1,Ethernet2 -Serveraddresses 192.168.0.1
Disable-NetAdapter "vEthernet (Internal network 1)"
```
iSCSI target
```powershell
# PLABDC01
Add-WindowsFeature FS-iSCSITarget-Server -IncludeManagementTools
```
Then go into Server Manager > File and Storage Services > iSCSI and start the **New iSCSI Virtual Disk Wizard**.
Create a fixed 500 MB iSCSI virtual disk on C:\ named "QuorumHD" and assign it to the `PLABDC01` iSCSI target server.
Add `plabdm01.practicelabs.com` and `plabsa01.practicelabs.com` as initiators, and keep authentication disabled, and confirm the disk has been created.
Create another virtual disk, 30 GB dynamic on D:\ names "CSVHD", and assign it to the same `PLABDC01` iSCSI target server.
###### Configure iSCSI initiators to iSCSI Target Server
On **PLABDM01**, open Server Manager and click on Tools > **iSCSI Initiator** and connect to `plabdc01.practicelabs.com`.
Bring disks 5 and 6 online and initialize them with [MBR][MBR] partition style.
This can be done within `diskmgmt.msc`, where the shared volumes that have been created will appear beneath the local disks, or using PowerShell:
```powershell
# PLABDM01
New-Volume -DiskNumber 5 -DriveLetter Q -FileSystem NTFS -FriendlyName 'Quorum'
New-Volume -DiskNumber 6 -DriveLetter V -FileSystem NTFS -FriendlyName 'CSV'
```
Only bring the disks online on the other client
```powershell
# PLABSA01
Set-Disk -Number 4,5 -IsOffline $false
```
###### Install failover clusters
On both **PLABDM01** and **PLABSA01**:
```powershell
Install-WindowsFeature failover-clustering -IncludeManagementTools
```
Then validate the installation through the [**Failover Cluster Manager**](img/image-m17-c-102.jpg) ([`cluadmin.msc`](README.md)).
Open the **Validate Configuration** wizard and enter `plabdm01.practicelabs.com` and `plabsa01.practicelabs.com` into the list of selected servers.

Open the **Create Cluster Wizard** and create cluster "PLHYPVCL01" using those same two nodes, choosing 192.168.**0**.25 and 192.168.**1**.25 for the administrative access points.

Open the [**Configure Cluster Quorum Wizard**](img/image-m17-c-103.jpg) and configure a disk witness using the Quorum shared volume.

Open **Hyper-V Manager** ([`virtmgmt.msc`](README.md)) and move **PLABDC02** and **PLABWIN811** to `V:\PLABDC02` and `V:\PLABWIN811` respectively, specifying the VM's **storage**.
Confirm the move has taken place by inspecting each VM's hard drive in the settings.

Add the **Virtual Machine** role to the **Failover Cluster Manager**, and select **PLABDC02** and **PLABWIN811**.
This will create the "PLABWIN811" Role, which actually includes both selected VMs.
Open **PLABWIN811 Properties**, then the **Failover** tab, and select "Allow failback" specifying between 1 and 2 hours.

Open **Hyper-V Manager** and start **PLABDC02**.
Wait until it has booted completely, then return to **Failover Cluster Manager**, open Nodes, right-click on **PLABDM01** and then Stop Cluster Service.
This option forces a failover of the VM, which drains to **PLABSA01**.
This can be confirmed by returning to **PLABSA01** and opening **Hyper-V Manager**, where it is revealed that **PLABDC02** is running.
### Scale-Out Fileserver lab
Plan network topology
```powershell
# PLABDM01
New-NetIpAddress 192.168.0.20 -PrefixLength 24 -InterfaceAlias Ethernet1
New-NetIpAddress 192.168.1.20 -PrefixLength 24 -InterfaceAlias Ethernet2
Set-DnsClientServerAddress -InterfaceAlias Ethernet1,Ethernet2 -ServerAddresses 192.168.0.1
Disable-NetAdapter -InterfaceAlias 'vethernet (internal network 1)'
```
```powershell
# PLABSA01
New-NetIpAddress 192.168.0.40 -PrefixLength 24 -InterfaceAlias Ethernet1
New-NetIpAddress 192.168.1.40 -PrefixLength 24 -InterfaceAlias Ethernet2
Set-DnsClientServerAddress -InterfaceAlias Ethernet1,Ethernet2 -ServerAddresses 192.168.0.1
```
Configure iSCSI target
```powershell
# PLABDC01
Install-WindowsFeature fs-iscsitarget-server -IncludeManagementTools
New-IscsiVirtualDisk -Fixed -SizeBytes 500mb -Path 'C:\QuorumHD.vhdx'
New-IscsiVirtualDisk -SizeBytes 30gb -Path 'D:\CSVHD.vhdx'
New-IscsiServerTarget -TargetName PLABDC01 -InitiatorId @('iqn:iqn.1991-05.com.microsoft:plabsa01.practicelabs.com','iqn:iqn.1991-05.com.microsoft:plabdm01.practicelabs.com')
Add-IscsiVirtualDiskTargetMapping -Path 'C:\QuorumHD.vhdx' -TargetName plabdc01
Add-IscsiVirtualDiskTargetMapping -Path 'D:\CSVHD.vhdx' -TargetName plabdc01
```
Configure iSCSI initiator on both clients
```powershell
# PLABDM01 and PLABSA01
Start-Service msiscsi
Get-NetFirewallServiceFilter -Service msiscsi | Get-NetFirewallRule | Enable-NetFirewallRule
Connect-iSCSITarget -NodeAddress (Get-iSCSITarget).NodeAddress
```
Install Failover Clustering role on nodes of the cluster
```powershell
# PLABDM01 and PLABSA01
Install-WindowsFeature failover-clustering -IncludeManagementTools
```
Create a failover cluster through the GUI (the Powershell commands for cluster creation appear not to support adding multiple network networks)
```powershell
# PLABDM01
New-Cluster -Name PLABSCL01 -Node PLABDM01, PLABSA01 -StaticAddress 192.168.0.25 -IgnoreNetwork 192.168.1.0/24
Set-ClusterQuorum -DiskWitness 'Cluster Disk 1'
```
### Hyper-V storage lab
Create a VM with VHDX disks
```powershell
New-VM -Name PLABWIN102 -Generation 1 -MemoryStartupBytes 1536mb -SwitchName 'Private network 1' -NewVHDPath 'C:\Users\Public\Documents\Hyper-V\Virtual hard disks\PLABWIN102.vhdx' -NewVHDSizeBytes 127gb
Set-VMDvdDrive -VMName PLABWIN102 -Path C:\Users\Administrator.PRACTICELABS\Documents\Eval81.iso
New-VHD -Path 'D:\Virtual Machines\PLAB1.vhdx' -Dynamic -SizeBytes 127gb
Add-VMHardDiskDrive -VMName PLABWIN102 -ControllerType IDE -ControllerNumber 0 -Path 'D:\Virtual Machines\PLAB1.vhdx'
```
Add a differencing disk
```powershell
New-VHD -Path 'D:\Virtual Machines\PLAB2.vhdx' -Differencing -ParentPath 'C:\Users\Public\Documents\Hyper-V\Virtual hard disks\PLABWIN102.vhdx'
Add-VMHardDrive PLABWIN102 SCSI -Path 'D:\Virtual Machines\PLAB2.vhdx'
```
Add a passthrough disk
```powershell
Set-Disk -Number 1 -IsOffline $true
Add-VMHardDiskDrive PLABWIN102 IDE 1 -DiskNumber 1
```
Create a SAN
```powershell
New-VMSan -Name "PLABS-Fc"
Add-VMFibreChannelHBA -VMName PLABDC02 -SanName "PLABS-Fc"
```
### Hyper-V replica lab
Emphasizes [**`VMReplication`**](pwsh.md#hyper-v) cmdlets.

```powershell
# PLABDM01
Enable-NetFirewallRule VIRT-HVRHTTPL-In-TCP-NoScope,VIRT-HVRHTTPSL-In-TCP-NoScope
```
Enable incoming replication on the receiving server
```powershell
#PLABSA01
Enable-NetFirewallRule VIRT-HVRHTTPL-In-TCP-NoScope,VIRT-HVRHTTPSL-In-TCP-NoScope
Set-Disk -Number 1,3,4 -IsOffline $false -IsReadOnly $false
New-Volume -DiskNumber 1 -FileSystem NTFS -FriendlyName VMReplica -DriveLetter E
Set-VmReplicationServer -ReplicationEnabled $true -AllowedAuthenticationType kerberos -ReplicationAllowedFromAnyServer $true -DefaultStorageLocation E:\VHD
```
Configure one VM and initiate initial replication
```powershell
# PLABDM01
Test-VMReplicationConnection PLABDC02 plabsa01.practicelabs.com 80 Kerberos
Enable-VMReplication PLABDC02 plabsa01.practicelabs.com 80 Kerberos
Start-VMInitialReplication PLABDC02
```
Repeat for another VM
```powershell
Enable-VMReplication PLABWIN811 plabsa01.practicelabs.com 80 Kerberos
Start-VMInitialReplication PLABWIN811
```
Initiate a planned failover
```powershell
Start-VMFailover PLABDC02
Start-VM PLABDC02
```
### WSUS lab
Almost totally GUI configuration of WSUS server after installation
```powershell
# PLABDM01
Add-WindowsFeature updateservices,updateservices-widdb,updateservices-services -IncludeManagementTools
mkdir C:\updates
```
```cmd
wsusutil.exe postinstall content_dir=C:\updates
```
### Storage replica lab
Actually from the [Practice test][mu:70-740].
```powershell
# On both origin and replica servers
Install-WindowsFeature storage-replica
Restart-Computer

Test-SRTopology
New-SRGroup -ComputerName server1
New-SRPartnership -SourceComputerName server1 -SourceRGName rg1 -SourceVolumeName D: -SourceLogVolumeName E: -DestinationComputerName server2 -DestinationRGName rg2 -DestinationVolumeName D: -DestinationLogVolumeName E:
```