# Exam Ref AZ-103 Microsoft Azure Administrator, by Michael Washam, Jonathan Tuliani, and Scott Hoag
JSON files are used:
  - Policy definitions (p. 15-20)
  - VM deployment (p. 49-50, 64, 230-240
  - Custom roles (88)
  - VM deployment with DSC extension (264)
PowerShell DSC (260)
## Contents
###   1: Manage Azure subscriptions and resource
####  1.1: Manage Azure Subscriptions
##### 1.1a: Assign administrator permissions
Azure methods of administering access to resources can be divided into two groups
  1. __Classic__ subscription administration roles 
    - Account Administrator
    - Service Administrator
    - Co-Administrator
  2. __Role-Based Access Controls (RBAC)__

Classic subscription administrators have full access to a subcription. They can access resources through Azure Portal, ARM APIs (PowerShell and CLI), and classic deployment model APIs. By default, the account that is used to sign up for a subscription is automatically set as both __Account Administrator__ and __Service Administrator__. There can only be one Account Administrator per account and only 1 Service Administrator per subscription. __Co-Administrators__ have the same access as Service Administrators, and there can be 200 of them per subscription, but cannot change the association of subscriptions to directories.

Current assignments for classic admins can be seen in the __Properties blade__ of a subscription in Azure Portal.
Co-Administrator assignments can be added by opening the __Access Control (IAM)__ blade of a subscription, then clicking the __Add co-administrator__ button. 

RBAC roles are supported only by Azure Portal and the ARM APIs. Access is applied to a __scope__, which includes subscriptions, resource groups, or resources. Azure Policy can be applied at various __scopes__. For example, a policy applied to a subscription is said to be at the "subscription scope". Policy can also be applied to Management Groups, which is an additional scope above subscription. In this way, several subscriptions can inherit a single policy through a Management Group.

There is a built-in role named __Resource Policy Contributor__, which includes access to most Policy operations and should be considered privileged.

RBAC roles can be used to grant rights to 2 types of principals:
  1. __User principal__: identity associated with a user or group of users.
  2. __Service principal__: identity associated with an application.

There are more than __70__ built-in RBAC roles, allowing fine-grained access management, but __4__ of them are foundational:
  1. __Owner__ has full access to all resources and __can__ delegate access. Service Administrator and Co-Administrators are assigned this role at the subscription scope.
  2. __Contributor__ can create and manage all resources, but __cannot__ delegate access.
  3. __Reader__ can view resources.
  4. __User Access Administrator__ only manages user access to resources.

RBAC roles can also be applied to a subscription through __Management Groups__, which represent the recommended practice for ensuring consistent application of tenant-wide security. Management groups form a hierarchy where each child inherits policy from its single parent while having additional controls. There is a singel Management Group at the root of the hierarchy, associated with the Azure AD tenant (which is associated, in turn, with a subscription) that cannot be moved or deleted. 
##### 1.1b: Configure cost center quotas and tagging
There are 2 types of quota that apply to subscriptions:
  1. __Resource quotas__ trigger alarms when resource creation and consumption hit a threshold. These are not to be confused with __resource limits__ which can stop resources from being created, whereas quotas can not.
  2. __Spending quotas__ trigger alarms when spending has reached a thresthold.
These are facilitated through the use of tags, which allow categorization of resource groups and resources. Tag **names** have a limit of 512 characters (128 characters for storage accounts) and tag **values** have a limit of 256 characters. Resources and resource groups are limited to **15** tags. VMs cannot exceed 2048 characters for all tag names and values combined. 
##### 1.1c: Configure Azure subscription policies
__Azure Policy__ is a service that can create, assign, and manage policies to enforce governance. Policy definitions, authored in JSON, implement policy by describing desired behavior for Azure resources when they are created or updated.\
To implement policy, a **policy definition** is created first, then a **policy assignment** assigns it to a scope. Policy definitions can be packaged together using **initiative definitions** and applied to a scope using **initiative assignments**
Comparison of Azure Policy and RBAC roles:
  - **RBAC roles** 
    - Control individual user and group access at specific scopes
    - Deny by default, allow explicitly
  - **Azure Policy** 
    - Allows environment to be governed for all users at a specific scope.
    - Allow by default, deny explicitly\
Azure Policy definition schema elements:
  - `mode`: which resources are scoped
    - `all`: both resource groups and all resources (default for policies defined in Portal)
    - `indexed`: only resource types that support tags and location (not all of them do)
  - `policyRule`
    - `if` block defines one or more conditions with logical operators
      - `field`: `type` represents type of resource being created based on the resource provider it belongs to
    - `then`: action to be taken
      - `effect` can have several values
        - `deny` generate an event in the activity log and fail the request
        - `audit` generate a warning event in the activity log but do not fail the request
        - `append` adds defined set of fields to the request
        - `auditifnotexists` enables auditing if a resource doesn't exist
        - `deployifnotexists` deploy a resource if it doesn't already exist
        - `disabled` don't evaluate resources for compliance to policy
      - `details`
  - `parameters`: make policy definitions reusable
    - name: i.e. `listOfAllowedSKUs`
      - `type` can be `string` or `array`
      - `metadata` is used by the Portal to display information for parameters; includes sub-properties `displayName`, `description`, and optionally `strongType`. `strongType` will produce a context menu of selections available populated by resources matching the value (i.e. if `vmSKUs` is the value it will produce a list of VMs when applying the policy)
      - `defaultValue`
      - `allowedValues`
####  1.2: Analyze resource utilization
A robust monitoring strategy implementing proactive notifications helps to increase uptime and optimize performance. Azure offers __Azure Monitor__ and __Azure Advisor__.
  - __Azure Monitor__ provides a single point of contact for both metrics and logs. 
  - __Azure Advisor__ is a free, personalized guide to Azure best practices that provides recommendations to help you optimize resources.
Distinction between __metrics__ and __logs__:
  - Metrics are strictly numerical, while logs can be numerical or textual
  - Metrics are continuously collected, while log entries are less predictable
Azure Monitor can create __alert rules__ that are built on target resources or resource type and that proactively notify you of the health of resources and can also leverage action groups that automate actions to take in certain conditions.
##### 1.2a: Configure diagnostic settings on resources
__Diagnostics logs__ are a type of log data that can be configured to send data to other locations, such as a Storage account or __Log Analytics__ workspace. Diagnostics logs have to be enabled for each resource to be monitored. Settings can be configured through Portal, ARM APIs, or the Azure Monitor REST APIs. __Azure Activity logs__ are another type of data that is surfaced at the subscription level, but lacks resource-level detail.
##### 1.2b: Create and test alerts
> Task: 1.2b.1 Create an alert rule (Portal)\
__Azure Monitor__ brings a unified alerting experience to Azure, with a single pane of glass for interacting with metrics, the __Activity Log__, __Log Analytics__, service and resource health and service-specific insights. Alerts have many notification options, including email, SMS, mobile app, voice, and integration with automation. Alerts are centered on but distinct from __alert rules__, which contain:
  - **Name and description**
  - __Target resource__, an Azure resource that generates signals, defines the scope and signals available for the alert.
  - __Signal__ (i.e. metric or Activity Log) emitted by target resource. Signals are of 3 types: 
    1. Metrics
    2. Log search queries 
    3. Activity logs
  - __Conditional logic__ for alert combines the signal and a logical test to trigger alert.
  - __Action Group__ determines what will happen when the alert is trigged. Action groups are themselves resources, and thus located in a subscription and resource group, and have:
    - **Name**
    - **Short name** is used to identify the Action Group in emails and notifications and is limited to 12 characters
    - **Actions** define the configuration for a specific action type. Available types includ:
      - Email/SMS/Push/Voice
      - Azure Function
      - Logic App
      - Webhook
      - ITSM
      - Automation Runbook
  - Severity (0-4)
##### 1.2c: Analyze alerts across subscriptions 
Alerts can have 3 states:
  - **New** and not reviewed
  - **Acknowledged** issue is being actioned by an admin
  - **Closed** issue that generated the alerts has been resolved and the alert has been marked as closed
These are changed by admins, not by the Azure platform.
##### 1.2d: Analyze metrics across subscriptions 
Metrics are the numerical values output by resources and services within Azure. They are collected a 1-minute intervals, identified by a metric name and namespace (category). Metrics can be one-dimensional or have up to 10 dimensions, and have the following properties:
  - **Time** the value was collected
  - **Type** of measurement made
  - **Resource** associated with value
  - **Value**
Metrics can be stored in:
  - Azure Monitor for 93 days
  - __Log Analytics__ for 2 years
  - Storage account, where they are treated according to the retention policy and storage limits of the account.
##### 1.2e Utilize log search query functions 
Comparison of logs and metrics\
Feature               | Logs                        | Metrics
:---                  | :---                        | :---
**Retention**         | Stored in Log Analytics (2 years) | Stored in Monitor for 93 days, but metrics can be sent to Log Analytics and Storage accounts as well
**Properties**        | Varying properties for each log, with support for rich data types such as date and time | Fixed set of properties (or attributes): time, type, resource, value, and (optionally) dimensions.
**Data availability** | Triggered by an event, requiring time to process before they are available for querying | Gathered at intervals and available for immediate querying.

**Log Analytics workspace** is where logs are collected and aggregated. The logs can be queried through Log Analytics or Monitor. Because a workspace is a resource, RBAC can be applied to control access to it. 
A workspace requires:
  - **Name** for the workspace
  - **Subscription** associated with it
  - **Resource group**
  - **Location**
  - **Pricing tier selection**
##### 1.2f Monitor for unused resources
Cost of VMs can be ameliorated by:
  - Deallocating compute when not needed
  - Deleting unused VMs when not in use
  - Right-sizing VMs
##### 1.2g Monitor and report spend
Cloudyn
Once a workspace is configured, machines can be onboarded. In order to report telemetry to Log Analytics, they must be running the **Azure Log Analytics (OMS) agent**, which needs to have port 443 open for inbound and outbound traffic on telemetered machines.\
Log Analytics uses the __Kusto__ query language. Kusto queries use the pipe character to separate commands, always begin with a scope, are case-sensitive, and generate read-only requests so log entries are only deleted based on retention policy.
##### 1.2f Monitor for unused resources 
__Azure Advisor__ offers personalized recommendations across 4 domains:
  - High availability
  - Security
  - Performance
  - Cost\
Virtual machines can be one of the most expensive resources in a cloud implementation, and there are several ways to reduce their cost
  - Deallocate compute when not needed
  - Delete unused virtual machines and allocate them only on demand
  - Right-size VMs so that you don't overuse resources\
Advisor can also identify
  - ExpressRoute circuits that have been "Not Provisioned" for more than 30 days
  - Gateways that have been idle for more than 90 days
##### 1.2g Monitor and report spend 
Customers on an __Enterprise Agreement__ can add up-front commitments to Azure then be billed annually. If the committed spend is exceeded, the overage is billed at the same EA rate. EA customers can create spending quotas and set notification thresholds through the EA Portal.\
3 portals used to manage Azure subscriptions
  1. EA Portal (ea.azure.com) available only to customers with an Enterprise Agreement
  2. Account Portal
  3. Azure Portal, includes Azure Cost Management
####  1.3: Manage resource groups
A resource group may not be nested within another, and although a resource may only be associated with a single resource group at a time, they can be moved around at will and resources from different resource groups can interact with one another. Resource groups can also be used to scope both access control and policy. Finally, a resource group is created in a location, which specified where its metadata is stored. Automating the creation and configuration of resources is recommended for consistent environments. To do this, use __Resource Manager templates__, which are JSON files that define the infrastructure and configuration of Azure resources.\
Resource Manager template required properties:
  - $schema
  - `contentVersion`
  - `resources`
Optional properties:
  - `parameters`
  - `variables`
  - `functions`
  - `outputs`
####  1.4: Manage role-based access control
##### 1.4a: Role-Based Access Control
> Terms: role, security principals
RBAC is configured by selecting a **role** and associating it with a **security principal**, such as a user, group, or service identity. Child reosurces inherit the roles of their parents (role inheritance).
##### 1.4b: How RBAC works
> Terms: role, security principal, scope\
3 components of a role assignment:
  1. **Security principal**: objects associated with a role definition and a scope to apply RBAC to azure resources (i.e. a user, group, service principal, or **managed identity** which is an application registration that is managed automatically by Azure and an Azure service)
  2. **Role definition**: list of permissions which define what actions can or cannot be performed against a resource. In addition to the 4 foundational roles, there are many other built-in roles and custom roles can be defined using a JSON file.
  3. **Scope**: 4 scopes at which RBAC can be applied: Management groups, subscriptions, resource groups, and resources
##### 1.4c: Implementing RBAC using the portal
###   2: Implement and Manage Storage
####  2.1: Create and configure storage accounts
##### 2.1a: Create and configure a storage account
4 storage services provided within each storage account:
  1. **Blobs** provides a highly scalable service for storing arbitrary data objects, such as text or binary data
  2. **Tables** provides a NoSQL-style store for storing structured data. Tables in Azure storage do not require a fixed schema, thus different entries in the same table can have different fields
  3. **Queues** provides reliable message queueing between application components
  4. **Files** provides managed file shares that can be used by VMs or on-premises servers\
3 types of storage blobs
  1. Block blobs
  2. Append blobs
  3. Page blobs: used to store VHD files when deploying unmanaged disks (not recommended)\
Options that must be selected when creating a storage account:
  - Performance tier
  - Account kind
  - Replication option
  - Access tier\ 
Performance tiers:
  1. **Standard** supports all storage services and uses magnetic disks to provide cost-efficient and reliable storage
  2. **Premium** only supports page blobs with the locally-redundant (LRS) replication option, uses high-performance SSD disks\ 
Replication options:
  - **Locally-redundant storage (LRS)** makes 3 local sychronous (within a single datacenter) copies 
  - **Zone-redundant storage (ZRS)** makes 3 synchronous copies across multiple availability zones; available for general-purpose v2 storage accounts at **Standard** performance tier only.
  - **Geographically-redundant storage (GRS)** makes 3 local synchronous copies plus 3 additional asynchronous copies (typically within 15 minutes, but no SLA) to a second data center far away from the primary region
  - **Read-access geographically redundant storage (RA-GRS)** makes 3 local synchronous copies plus 3 additional asynchronous copies to a second data center far away from the primary region, which has only read-only access\ 
Blob storage access tiers
  1. **Hot** blob storage access tier optimized for the frequent access of objects in the storage account
  2. **Cool** blob storage access tier optimized for storing large amounts of data that is infrequently accessed and stored for at least 30 days
  3. **Archive** blob storage access tier designed for long-term storage of infrequently-used data that can tolerate several hours of retrieval latency, remaining in the Archive tier for at least 180 days. It is stored offline and can take up to 15 hours for it to be "rehydrated" to the Cool or Hot tier before it can be accessed.
  4. **Premium** providing high-performance access for frequently-used data on SSD, only available from the **Block Blob** storage account type.\ 
Account kinds:
  1. General-purpose V2: only kind to support ZRS
  2. General-purpose V1: does not support various access tiers.
  3. Blob storage: specialized storage account used to store block and append blobs\ 
Both Blob and StorageV1 can be upgraded to StorageV2, a process which is irreversible. 
##### 2.1b: Configure network access to the storage account
> Terms: endpoint, Shared Access Signature token\
Storage accounts are managed through __Azure Resource Manager__ and management operations are authenticated and authorized using __Azure Active Directory__. Every storage account service exposes its own Internet-facing endpoint, which must be secured in one of several ways.

The __storage firewall__ controls IP addresses and VNets can access the storage account and applies to all storage account services.

For blob storage only, an additional access control is available. By default, no public read access is enabled for anonymous users, but users with RBAC rights or with the storage account name and key can have access. This can be done through ARM APIs, the Portal, or Azure Storage Explorer. Container access levels:
  - No public read access: container and blobs can only be accessed by storage account owner  (default for new containers)
  - Public read-only access for blobs only (container data is not available, and anonymous clients cannot enumerate the blobs within the container)
  - Full public read-only access: all container and blob data can be read by anonymous requests:
##### 2.1c: Manage access keys
Access keys grant full access to all data in all services of a storage account and represent the simplest and most powerful control over access. Access keys are typically used by applications for access to Azure storage, either through a __Shared Access Signature (SAS)__ token or directly accessing the storage itself with the name and key.

Access keys can be regenerated using the Portal or CLI tools (`New-AzStorageAccountKey` or `az storage account keys renew`)
##### 2.1d: Generate a shared access signature
Generate SAS tokens using Storage Explorer or the CLI. PowerShell commands:
  - `New-AzStorageAccountSASToken`
  - `New-AzStorageBlobSASToken`
  - `New-AzStorageContainerSASToken`
  - `New-AzStorageFileSASToken`
  - `New-AzStorageQueueSASToken`
  - `New-AzStorageShareSASToken`
  - `New-AzStorageTableSASToken`
##### 2.1e: Monitor activity log by using Log Analytics
> Terms: Azure Activity log\
**Azure Activity log** is a subscription level log that captures events that range from operational data (i.e. resource creation, deletion) to service health events for a subscription.
##### 2.1f: Implement Azure Storage replication
Storage accounts can be moved freely between LRS, GRS, and RA-GRS replication modes. The data will be replicated in the background asynchronously as required. But ZRS works differently, and the data should simply be copied to a new storage account if the replication option needs to be changed.
####  2.2: Import and export
##### 2.2a: Configure and use Azure blob storage
There can be multiple **containers** within a storage account, and a container can have its own folder structure.

3 types of blob:
  1. **Page blob**
  2. **Block blob**
  3. **Append blob**
##### 2.2b: Create export from Azure job
##### 2.2c: Create import into Azure job
##### 2.2d: Use Azure Data Box
3 variations of Data Box:
  - **Data Box Disk**: up to 35 TB and 1 storage account
  - **Data Box**: up to 80 TB and 10 storage accounts
  - **Data Box Heavy**: up to 800 TB and 10 storage accounts
Workflow of Data Box usage:
  1. Order: Use Portal to order a data box by creating a Data Box resource
  2. Receive: Connect Data Box to network
  3. Copy data: Mount file shares and copy data to the device.
  4. Return: to Microsoft
  5. Upload: Microsoft will upload the data and securely erase it from the device
##### 2.2e: Configure Azure content delivery network (CDN) endpoints
> Terms: CNAME\
Users can use Azure as a CDN cache, reducing load from website. Content is cached by the CDN until its **time-to-live (TTL)** elapses, which can be controlled in the HTTP response from the origin server.\
Permanently removing content from the CDN requires it be first removed from the origin servers, meaning if the content is in a storage account it should be set to private or deleted from the storage, or the container itself should be deleted. Cached copies may remain in the CDN endpoint until the TTL has expired, unless it is **purged**.\
Custom domains can be used by implementing **CNAME** DNS records, which are used in DNS to map alias domain names to the "canonical" name.
####  2.3: Configure Azure files
> Terms: Azure File Service\
__Azure File Service__ allows you to create one or more file shares in the cloud (up to 5 TB per share), similar to a regular Windows File Server. It supports SMB protocol, so you can connect directly to a file share from outside of Azure, if traffic to port 445 is allowed through the LAN and ISP. It can also be mapped within Windows.
##### 2.3a: Using Azure File Service
Use cases:
  - Replace on-premises file servers
  - Easily replicate data on-premises to make it available during lift-and-shift migrations
  - Simply cloud development and management
##### 2.3b: Create Azure File Sync service
> Terms: Azure File Sync\
**Azure File Sync** extends Azure File Service to allow on-premises file services to be extended to Azure while maintaining performance and compatibility.
##### 2.3c: Create Azure sync group
> Terms: endpoint, Azure File Sync agent\
##### 2.3d: Troubleshoot Azure File Sync
Several procedures to be used when Azure File Sync is having issues
####  2.4: Implement Azure Backup
##### 2.4a: Create Recovery Services Vault
> Terms: Azure Backup, Recovery Services vault
##### 2.4b: Backup and restore data
> Terms: Microsoft Azure Recovery Services (MARS) agent, Azure Backup Server\
Types of backup agents that can be used with **Azure Backup**
  - Microsoft Azure Recovery Services (MARS) agent
  - DPM protection agent
  - VMSnapshot extension
##### 2.4c: Configure and review backup reports
> Terms: Azure Backup Reports
This section focuses on implementing data visualization from within Power BI, currently in preview.
##### 2.4d: Create and configure backup policy
...
###   3: Deploy and manage virtual machines
####  3.1 Create and configure a VM for Windows and Linux
##### 3.1a: Creating virtual machines
3 types of disks avialable to Virtual Machines:
  - Operating System Disk (OS Disk)
  - Temporary Disk
  - Data Disk
##### 3.1b: Configuring high availability
**Availability zones** protect from datacenter-level failures by providing physical and logical separation between VM instances. Zones have independent power sources, network, and cooling, and there are at least 3 zones in every region.\
**Availability sets** offer redundancy for VMs in the same application tier, ensuring at least one VM is available in the case of a host update or problem. Each VM is assigned a **fault domain** (representing separate physical racks in the datacenter) and an **update domain** (representing groups of VMs and underlying physical hardware that can be rebooted at the same time for host updates). Every availability set has up to 20 update domains and 3 fault domains available.\
A VM joined to an availability zone **may not** be also joined to an **availability set**.
##### 3.1c: Configure virtual machine size
##### 3.1d: Authentication options
##### 3.1e: Configure storage
> Terms: BlobCache
##### 3.1f: Configure networking
##### 3.1g: Configure monitoring
##### 3.1h: Deploy and configure scale sets
**VM scale sets (VMSS)** support the ability to dynamically add and remove instances. By default, a VMSS supports up to 100 instances or up to 1000 instances if deployed with the property `singlePlacementGroup` set to false (called a **large-scale set**). A **placement group** is a concept similar to an availability set in that it assigns fualt and upgrade domains. By default, a scale set consists of only a single placement group, but disabling this setting allows the scale set to be composed of multiple placement groups. If a custom image is used instead of one in the gallery, the limit is actually 300 instances.
####  3.3
##### 3.3f: Automate configuration management
> Terms: Desired State Conofiguration (DSC)
Azure VMs have built-in extensions that enable configuration management. 2 most common extensions for configuration management:
- Windows PowerShell **Desired State Configuration (DSC)** allows you to define the state of a VM using **PowerShell Desired State Configuration language** 
##### 3.4a: Manage VM Backups
> Terms: VMSnapshot, VMSnapshotLinux, Azure Backup Server
##### 3.4d: Perform VM restore
2 methods to restore data after backing up a VM to Azure Backup:
  1. Restore a recovery point as a new VM
  2. Restore access to files only
###   4: Configure and manage virtual networks
####  4.1
> Terms: Classless Inter-Domain Routing
Azure uses **Classless Inter-Domain Routing (CIDR)** notation when describing subnets.
##### 4.1d: Configure network routes
> Terms: forced tunneling
####  4.4
> Terms: Network security group (NSG)
##### 4.4c
> Terms: Service Map
####  4.6
##### 4.6a: Monitor on-premises connectivity
> Terms: Azure Network Performance Monitor (NPM), Performance Monitor, Service Connectivity Monitor, ExpressRoute Monitor
3 services provided by NPM:
  - Performance Monitor
  - Service Connectivity Monitor
  - ExpressRoute
##### 4.6c: Use Network Watcher
> Terms: Network Watcher, IP Flow Verify, Next Hop, Packet Capture
Network Watcher monitoring and diagnostic tools:
  - IP Flow Verify
  - Next Hop
  - Packet Capture
  - Network Topology